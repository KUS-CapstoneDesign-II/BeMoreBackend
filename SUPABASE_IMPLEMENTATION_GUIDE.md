# üöÄ Supabase Íµ¨ÌòÑ Í∞ÄÏù¥Îìú - BeMore ÌîÑÎ°úÏ†ùÌä∏

**ÏÉÅÌÉú**: ‚úÖ Ï§ÄÎπÑ ÏôÑÎ£å
**ÎåÄÏÉÅ**: BeMore Í∞êÏ†ï Î∂ÑÏÑù ÏãúÏä§ÌÖú Ï†ÑÏö© ÏÉà Supabase ÌîÑÎ°úÏ†ùÌä∏
**Í∏∞Î∞ò**: IMPROVED_SCHEMA_V2_1_FIXED.md (Î™®Îì† ChatGPT ÌîºÎìúÎ∞± Ï†ÅÏö©)
**ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ**: ~30Î∂Ñ (Î™®Îì† Îã®Í≥Ñ Ìè¨Ìï®)

---

## üìã ÏÇ¨Ï†Ñ Ï§ÄÎπÑÏÇ¨Ìï≠

### ÌôïÏù∏ ÏÇ¨Ìï≠
- [ ] Supabase Í≥ÑÏ†ï ÏÉùÏÑ± ÏôÑÎ£å (https://supabase.com)
- [ ] BeMore Ï†ÑÏö© **ÏÉà ÌîÑÎ°úÏ†ùÌä∏** ÏÉùÏÑ± Ï§ÄÎπÑ (Í∏∞Ï°¥ ÎèÖÏÑú Ïï± DBÏôÄ Î∂ÑÎ¶¨)
- [ ] Ïõπ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Supabase ÎåÄÏãúÎ≥¥Îìú Ï†ëÏÜç Í∞ÄÎä•

---

## üéØ Phase 1: Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± (5Î∂Ñ)

### Step 1.1: ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±

1. **Supabase ÎåÄÏãúÎ≥¥Îìú** Ï†ëÏÜç: https://app.supabase.com
2. **"New project"** ÌÅ¥Î¶≠
3. Îã§Ïùå Ï†ïÎ≥¥ ÏûÖÎ†•:
   ```
   Project Name: BeMore-EmotionAnalysis
   Database Password: [Í∞ïÎ†•Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÄÏû•]
   Region: Asia Pacific (ap-southeast-1) - ÏÑúÏö∏
   ```
4. **"Create new project"** ÌÅ¥Î¶≠
5. ‚è≥ 2-3Î∂Ñ ÎåÄÍ∏∞ (ÌîÑÎ°úÏ†ùÌä∏ ÌîÑÎ°úÎπÑÏ†ÄÎãù)

### Step 1.2: SQL Editor Ï†ëÏÜç

1. ÌîÑÎ°úÏ†ùÌä∏ ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞
2. ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î ‚Üí **SQL Editor**
3. **"+ New Query"** ÌÅ¥Î¶≠
4. Îπà SQL ÏóêÎîîÌÑ∞ Ï§ÄÎπÑ

---

## üîß Phase 2: Ïä§ÌÇ§Îßà ÏÑ§Ï†ï (15Î∂Ñ)

### ‚ö†Ô∏è Ï§ëÏöî: Îã®Í≥ÑÎ≥Ñ Ïã§Ìñâ ÌïÑÏàò!

**Îã§Ïùå Îã®Í≥ÑÎì§ÏùÑ ÏàúÏÑúÎåÄÎ°ú **ÌïòÎÇòÏî©** SQL EditorÏóêÏÑú Ïã§ÌñâÌïòÏÑ∏Ïöî. Ìïú Î≤àÏóê Î™®Îëê Î∂ôÏó¨ÎÑ£ÏúºÎ©¥ Ïò§Î•ò Î∞úÏÉù!**

---

### Step 0: ÌôïÏû• ÏÑ§Ïπò (ÌïÑÏàò Î®ºÏ†Ä Ïã§Ìñâ)

**Î®ºÏ†Ä Ïã§Ìñâ**ÌïòÍ≥† ‚úÖ ÏÑ±Í≥µ ÌôïÏù∏ ÌõÑ Îã§Ïùå Îã®Í≥Ñ ÏßÑÌñâ

```sql
-- ============================================
-- ÌôïÏû• ÏÑ§Ïπò (ÌïÑÏàò)
-- ============================================
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

**‚úÖ Ïã§Ìñâ ÌõÑ**: Î©îÏãúÏßÄ ÌôïÏù∏
```
CREATE EXTENSION
```

---

### Step 1: ENUM ÌÉÄÏûÖ Ï†ïÏùò

```sql
-- ============================================
-- ENUM ÌÉÄÏûÖ Ï†ïÏùò (Ïó¥Í±∞Ìòï)
-- ============================================

CREATE TYPE emotion_type AS ENUM (
  'happy',
  'sad',
  'angry',
  'anxious',
  'excited',
  'neutral'
);

CREATE TYPE session_status AS ENUM (
  'active',
  'paused',
  'ended'
);

CREATE TYPE counselor_status AS ENUM (
  'active',
  'inactive'
);

CREATE TYPE language_type AS ENUM (
  'ko',
  'en'
);

CREATE TYPE expertise_level_type AS ENUM (
  'beginner',
  'intermediate',
  'expert'
);
```

---

### Step 2: Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò Ï†ïÏùò

```sql
-- ============================================
-- Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò: updated_at ÏûêÎèô Í∞±Ïã†
-- ============================================
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò: session_id Î∂àÎ≥ÄÏÑ± Í∞ïÏ†ú
-- ============================================
CREATE OR REPLACE FUNCTION forbid_update_session_id()
RETURNS trigger AS $$
BEGIN
  IF NEW.session_id IS DISTINCT FROM OLD.session_id THEN
    RAISE EXCEPTION 'session_id is immutable and cannot be updated';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò: Í∞êÏÇ¨ Î°úÍπÖ (Í∞êÏÇ¨ Ï∂îÏ†Å)
-- ============================================
CREATE OR REPLACE FUNCTION audit_row()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.bemore_audit_log(
    table_name,
    record_id,
    operation,
    old_data,
    new_data,
    changed_by,
    changed_at
  ) VALUES (
    TG_TABLE_NAME,
    COALESCE(NEW.id, OLD.id),
    TG_OP,
    to_jsonb(OLD),
    to_jsonb(NEW),
    COALESCE(auth.uid()::text, 'system'),
    now()
  );
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;
```

---

### Step 3: ÏÇ¨Ïö©Ïûê Î∞è ÏÉÅÎã¥ÏÇ¨ ÌÖåÏù¥Î∏î

```sql
-- ============================================
-- 1. BeMore ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î (Supabase Auth Ïó∞Îèô)
-- ============================================
CREATE TABLE public.bemore_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  auth_user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  user_id TEXT UNIQUE NOT NULL,
  username TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  phone_encrypted TEXT,  -- pgcrypto ÏïîÌò∏Ìôî Í∞ÄÎä•
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_users_auth_user_id ON public.bemore_users(auth_user_id);
CREATE INDEX idx_bemore_users_user_id ON public.bemore_users(user_id);

-- updated_at ÏûêÎèô Í∞±Ïã† Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_users_updated
BEFORE UPDATE ON public.bemore_users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ============================================
-- 2. ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ ÌÖåÏù¥Î∏î (Í∞úÏù∏ Ï†ïÎ≥¥ Î∂ÑÎ¶¨)
-- ============================================
CREATE TABLE public.bemore_user_profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  full_name TEXT,
  date_of_birth DATE,
  gender TEXT,
  occupation TEXT,
  bio TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_user_profiles_user_id ON public.bemore_user_profiles(user_id);

-- updated_at Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_user_profiles_updated
BEFORE UPDATE ON public.bemore_user_profiles
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ============================================
-- 3. ÏÉÅÎã¥ÏÇ¨ ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_counselors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  auth_user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  counselor_id TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  license_number TEXT,
  license_expiry DATE,
  status counselor_status DEFAULT 'active',
  expertise_level expertise_level_type DEFAULT 'intermediate',
  bio TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_counselors_auth_user_id ON public.bemore_counselors(auth_user_id);
CREATE INDEX idx_bemore_counselors_counselor_id ON public.bemore_counselors(counselor_id);
CREATE INDEX idx_bemore_counselors_status ON public.bemore_counselors(status);

-- updated_at Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_counselors_updated
BEFORE UPDATE ON public.bemore_counselors
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- Í∞êÏÇ¨ Î°úÍπÖ Ìä∏Î¶¨Í±∞
CREATE TRIGGER audit_bemore_counselors
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_counselors
FOR EACH ROW EXECUTE FUNCTION audit_row();

-- ============================================
-- 4. ÏÉÅÎã¥ÏÇ¨ ÌäπÎ¨∏ Î∂ÑÏïº (Îã§ÎåÄÎã§ Í¥ÄÍ≥Ñ)
-- ============================================
CREATE TABLE public.counselor_specialties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  counselor_id UUID NOT NULL REFERENCES public.bemore_counselors(id) ON DELETE CASCADE,
  specialty TEXT NOT NULL,
  certification_year INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_counselor_specialties_counselor_id ON public.counselor_specialties(counselor_id);
```

---

### Step 4: ÏÑ∏ÏÖò ÏΩîÏñ¥ ÌÖåÏù¥Î∏î

```sql
-- ============================================
-- 5. BeMore ÏÑ∏ÏÖò ÌÖåÏù¥Î∏î (ÌïµÏã¨!)
-- ============================================
CREATE TABLE public.bemore_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id TEXT UNIQUE NOT NULL,
  user_id UUID NOT NULL REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  counselor_id UUID REFERENCES public.bemore_counselors(id) ON DELETE SET NULL,
  status session_status NOT NULL DEFAULT 'active',
  started_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  ended_at TIMESTAMP WITH TIME ZONE,
  duration INTERVAL GENERATED ALWAYS AS (ended_at - started_at) STORED,

  -- Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
  emotions_data JSONB DEFAULT '[]'::jsonb,

  -- Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
  valid_frames INTEGER DEFAULT 0 CHECK (valid_frames >= 0),
  total_frames INTEGER DEFAULT 0 CHECK (total_frames >= 0),
  average_intensity NUMERIC(5, 2) CHECK (average_intensity BETWEEN 0 AND 100),
  speech_seconds NUMERIC(8, 2) CHECK (speech_seconds >= 0),
  silence_seconds NUMERIC(8, 2) CHECK (silence_seconds >= 0),
  words_count INTEGER CHECK (words_count >= 0),

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_sessions_user_id ON public.bemore_sessions(user_id);
CREATE INDEX idx_bemore_sessions_counselor_id ON public.bemore_sessions(counselor_id);
CREATE INDEX idx_bemore_sessions_session_id ON public.bemore_sessions(session_id);
CREATE INDEX idx_bemore_sessions_status ON public.bemore_sessions(status);
CREATE INDEX idx_bemore_sessions_created_at ON public.bemore_sessions(created_at);
CREATE INDEX idx_bemore_sessions_emotions_data ON public.bemore_sessions USING GIN (emotions_data);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_sessions_updated
BEFORE UPDATE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER t_bemore_sessions_sessionid_ro
BEFORE UPDATE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION forbid_update_session_id();

CREATE TRIGGER audit_bemore_sessions
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 5: Í∞êÏ†ï Î∞è Î©îÌä∏Î¶≠ ÌÖåÏù¥Î∏î

```sql
-- ============================================
-- 6. Í∞êÏ†ï ÌÉÄÏûÑÎùºÏù∏ ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_emotions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  emotion emotion_type NOT NULL,
  emotion_ko TEXT NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  frame_count INTEGER,
  stt_snippet TEXT,
  intensity NUMERIC(5, 2) CHECK (intensity BETWEEN 0 AND 100),
  confidence_score NUMERIC(5, 4) CHECK (confidence_score BETWEEN 0 AND 1),
  vad_score NUMERIC(5, 4) CHECK (vad_score BETWEEN 0 AND 1),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_emotions_session_id ON public.bemore_emotions(session_id);
CREATE INDEX idx_bemore_emotions_timestamp ON public.bemore_emotions(timestamp);
CREATE INDEX idx_bemore_emotions_emotion ON public.bemore_emotions(emotion);

-- ============================================
-- 7. ÏÑ∏ÏÖò Î©îÌä∏Î¶≠ ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_session_metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  total_duration INTERVAL,
  speech_duration INTERVAL,
  silence_duration INTERVAL,
  total_frames INTEGER CHECK (total_frames >= 0),
  valid_frames INTEGER CHECK (valid_frames >= 0),
  face_detection_rate NUMERIC(5, 2) CHECK (face_detection_rate BETWEEN 0 AND 100),
  speech_ratio NUMERIC(5, 2) CHECK (speech_ratio BETWEEN 0 AND 100),
  words_detected INTEGER CHECK (words_detected >= 0),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_session_metrics_session_id ON public.bemore_session_metrics(session_id);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_session_metrics_updated
BEFORE UPDATE ON public.bemore_session_metrics
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

---

### Step 6: Î∂ÑÏÑù Î∞è Î¶¨Ìè¨Ìä∏ ÌÖåÏù¥Î∏î

```sql
-- ============================================
-- 8. ÏÑ∏ÏÖò Î¶¨Ìè¨Ìä∏ ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  emotion_count INTEGER CHECK (emotion_count >= 0),
  primary_emotion emotion_type,
  emotional_state TEXT,
  trend TEXT,
  positive_ratio NUMERIC(5, 2) CHECK (positive_ratio BETWEEN 0 AND 100),
  negative_ratio NUMERIC(5, 2) CHECK (negative_ratio BETWEEN 0 AND 100),
  analysis_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_reports_session_id ON public.bemore_reports(session_id);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_reports_updated
BEFORE UPDATE ON public.bemore_reports
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ============================================
-- 9. ÏÑ∏ÏÖò Ìö®Í≥ºÏÑ± ÌèâÍ∞Ä ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_session_assessments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  counselor_assessment TEXT,
  user_feedback TEXT,
  recommendation TEXT,
  follow_up_needed BOOLEAN DEFAULT false,
  assessed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_session_assessments_session_id ON public.bemore_session_assessments(session_id);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_session_assessments_updated
BEFORE UPDATE ON public.bemore_session_assessments
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

---

### Step 7: ÌîºÎìúÎ∞± Î∞è ÏÑ§Ï†ï ÌÖåÏù¥Î∏î

```sql
-- ============================================
-- 10. ÌîºÎìúÎ∞± ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_feedback (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_feedback_session_id ON public.bemore_feedback(session_id);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER audit_bemore_feedback
AFTER INSERT ON public.bemore_feedback
FOR EACH ROW EXECUTE FUNCTION audit_row();

-- ============================================
-- 11. ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÌÖåÏù¥Î∏î
-- ============================================
CREATE TABLE public.bemore_user_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  language language_type DEFAULT 'ko',
  notifications_enabled BOOLEAN DEFAULT true,
  email_notifications BOOLEAN DEFAULT true,
  theme TEXT DEFAULT 'light',
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_user_preferences_user_id ON public.bemore_user_preferences(user_id);

-- Ìä∏Î¶¨Í±∞
CREATE TRIGGER t_bemore_user_preferences_updated
BEFORE UPDATE ON public.bemore_user_preferences
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

---

### Step 8: Í∞êÏ†ï ÏõîÎ≥Ñ ÏöîÏïΩ Î∞è Í∞êÏÇ¨ Î°úÍ∑∏

```sql
-- ============================================
-- 12. Í∞êÏ†ï ÏõîÎ≥Ñ ÏöîÏïΩ ÌÖåÏù¥Î∏î (Î∂ÑÏÑù ÏµúÏ†ÅÌôî)
-- ============================================
CREATE TABLE public.bemore_emotion_monthly_summary (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  year_month DATE NOT NULL,
  total_sessions INTEGER CHECK (total_sessions >= 0),
  total_emotions INTEGER CHECK (total_emotions >= 0),
  happy_count INTEGER CHECK (happy_count >= 0),
  sad_count INTEGER CHECK (sad_count >= 0),
  angry_count INTEGER CHECK (angry_count >= 0),
  anxious_count INTEGER CHECK (anxious_count >= 0),
  excited_count INTEGER CHECK (excited_count >= 0),
  neutral_count INTEGER CHECK (neutral_count >= 0),
  average_intensity NUMERIC(5, 2) CHECK (average_intensity BETWEEN 0 AND 100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE(user_id, year_month)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_emotion_monthly_summary_user_id ON public.bemore_emotion_monthly_summary(user_id);
CREATE INDEX idx_bemore_emotion_monthly_summary_year_month ON public.bemore_emotion_monthly_summary(year_month);

-- ============================================
-- 13. Í∞êÏÇ¨ Î°úÍ∑∏ ÌÖåÏù¥Î∏î (Í∞êÏãú Ï∂îÏ†Å)
-- ============================================
CREATE TABLE public.bemore_audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  table_name TEXT NOT NULL,
  record_id TEXT NOT NULL,
  operation TEXT NOT NULL CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
  old_data JSONB,
  new_data JSONB,
  changed_by TEXT,
  changed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bemore_audit_log_table_name ON public.bemore_audit_log(table_name);
CREATE INDEX idx_bemore_audit_log_record_id ON public.bemore_audit_log(record_id);
CREATE INDEX idx_bemore_audit_log_changed_at ON public.bemore_audit_log(changed_at);
CREATE INDEX idx_bemore_audit_log_operation ON public.bemore_audit_log(operation);
```

---

## üîê Phase 3: Row Level Security (RLS) ÏÑ§Ï†ï (5Î∂Ñ)

### Step 9: RLS ÌôúÏÑ±Ìôî

```sql
-- ============================================
-- RLS ÌôúÏÑ±Ìôî (Î™®Îì† ÌÖåÏù¥Î∏î)
-- ============================================
ALTER TABLE public.bemore_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_counselors ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_emotions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_session_metrics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_feedback ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bemore_user_preferences ENABLE ROW LEVEL SECURITY;
```

---

### Step 10: RLS Ï†ïÏ±Ö ÏÑ§Ï†ï

```sql
-- ============================================
-- bemore_users RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Ï†ïÎ≥¥Îßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_users
  FOR SELECT
  USING (auth_user_id = auth.uid());

CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Ï†ïÎ≥¥Îßå ÏàòÏ†ï Í∞ÄÎä•"
  ON public.bemore_users
  FOR UPDATE
  USING (auth_user_id = auth.uid());

-- ============================================
-- bemore_user_profiles RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÌîÑÎ°úÌïÑÎßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_user_profiles
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.bemore_users
      WHERE id = user_id AND auth_user_id = auth.uid()
    )
  );

CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÌîÑÎ°úÌïÑÎßå ÏàòÏ†ï Í∞ÄÎä•"
  ON public.bemore_user_profiles
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM public.bemore_users
      WHERE id = user_id AND auth_user_id = auth.uid()
    )
  );

-- ============================================
-- bemore_sessions RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏÑ∏ÏÖòÎßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_sessions
  FOR SELECT
  USING (
    user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
    OR counselor_id = (SELECT id FROM public.bemore_counselors WHERE auth_user_id = auth.uid())
  );

CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏÑ∏ÏÖòÎßå ÏàòÏ†ï Í∞ÄÎä•"
  ON public.bemore_sessions
  FOR UPDATE
  USING (
    user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
  );

-- ============================================
-- bemore_emotions RLS Ï†ïÏ±Ö (ÏûêÏã†Ïùò ÏÑ∏ÏÖò Í∞êÏ†ïÎßå)
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏÑ∏ÏÖò Í∞êÏ†ïÎßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_emotions
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.bemore_sessions
      WHERE id = session_id AND (
        user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
        OR counselor_id = (SELECT id FROM public.bemore_counselors WHERE auth_user_id = auth.uid())
      )
    )
  );

-- ============================================
-- bemore_reports RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Î¶¨Ìè¨Ìä∏Îßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_reports
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.bemore_sessions
      WHERE id = session_id AND (
        user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
        OR counselor_id = (SELECT id FROM public.bemore_counselors WHERE auth_user_id = auth.uid())
      )
    )
  );

-- ============================================
-- bemore_feedback RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÌîºÎìúÎ∞±Îßå ÏÇΩÏûÖ Í∞ÄÎä•"
  ON public.bemore_feedback
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.bemore_sessions
      WHERE id = session_id AND user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
    )
  );

CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÌîºÎìúÎ∞±Îßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_feedback
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM public.bemore_sessions
      WHERE id = session_id AND user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
    )
  );

-- ============================================
-- bemore_user_preferences RLS Ï†ïÏ±Ö
-- ============================================
CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏÑ§Ï†ïÎßå Ï°∞Ìöå Í∞ÄÎä•"
  ON public.bemore_user_preferences
  FOR SELECT
  USING (
    user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
  );

CREATE POLICY "ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏÑ§Ï†ïÎßå ÏàòÏ†ï Í∞ÄÎä•"
  ON public.bemore_user_preferences
  FOR UPDATE
  USING (
    user_id = (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid())
  );
```

---

## ‚úÖ Phase 4: Í≤ÄÏ¶ù Î∞è ÌÖåÏä§Ìä∏ (5Î∂Ñ)

### Step 11: ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÌôïÏù∏

Supabase ÎåÄÏãúÎ≥¥ÎìúÏùò **Table Editor**ÏóêÏÑú Îã§Ïùå ÌÖåÏù¥Î∏î ÌôïÏù∏:

```
‚úÖ bemore_users
‚úÖ bemore_user_profiles
‚úÖ bemore_counselors
‚úÖ counselor_specialties
‚úÖ bemore_sessions
‚úÖ bemore_emotions
‚úÖ bemore_session_metrics
‚úÖ bemore_reports
‚úÖ bemore_session_assessments
‚úÖ bemore_feedback
‚úÖ bemore_user_preferences
‚úÖ bemore_emotion_monthly_summary
‚úÖ bemore_audit_log
```

### Step 12: Ïó∞Í≤∞ Î¨∏ÏûêÏó¥ Î≥µÏÇ¨

1. **Project Settings** ‚Üí **Database**
2. **Connection pooling** ÏÑπÏÖò Ï∞æÍ∏∞
3. Ïó∞Í≤∞ Î¨∏ÏûêÏó¥ Î≥µÏÇ¨:
   ```
   postgresql://[user]:[password]@[host]:5432/postgres?schema=public
   ```
4. ÏïàÏ†ÑÌïú Í≥≥Ïóê Ï†ÄÏû• (Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÌïÑÏöî)

---

## üîå Phase 5: Backend Ïó∞Îèô (5Î∂Ñ)

### Step 13: Î°úÏª¨ .env ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏

ÌîÑÎ°úÏ†ùÌä∏ Î£®Ìä∏Ïóê `.env` ÌååÏùº ÏàòÏ†ï:

```bash
# Database Configuration
DATABASE_URL="postgresql://[user]:[password]@[host]:5432/postgres?schema=public"

# Í∏∞Ï°¥ ÏÑ§Ï†ï Ïú†ÏßÄ
NODE_ENV=development
PORT=8000
GOOGLE_API_KEY=your_gemini_api_key
```

### Step 14: Sequelize ÏÑ§Ï†ï ÌôïÏù∏

[config/database.js](config/database.js) ÌôïÏù∏:

```javascript
module.exports = {
  development: {
    url: process.env.DATABASE_URL,
    dialect: 'postgres',
    protocol: 'postgresql',
    logging: console.log,
    pool: {
      max: 5,
      min: 0,
      acquire: 30000,
      idle: 10000,
    },
    dialectOptions: {
      ssl: {
        require: true,
        rejectUnauthorized: false
      }
    }
  }
};
```

### Step 15: Î°úÏª¨ ÌÖåÏä§Ìä∏

```bash
# Í∏∞Ï°¥ ÏÑúÎ≤Ñ Ï¢ÖÎ£å
pkill -f "npm run dev"

# ÏÉà DATABASE_URL ÌôòÍ≤Ω Ï†ÅÏö©
export DATABASE_URL="postgresql://..."

# ÏÑúÎ≤Ñ ÏãúÏûë
npm run dev
```

**ÏòàÏÉÅ Í≤∞Í≥º**:
```
‚úÖ [DATABASE] Connected to Supabase PostgreSQL
‚úÖ [SERVER] Running on http://localhost:8000
```

### Step 16: API ÌÖåÏä§Ìä∏

```bash
# ÏÑ∏ÏÖò ÏÉùÏÑ± ÌÖåÏä§Ìä∏
curl -X POST http://localhost:8000/api/session/start \
  -H "Content-Type: application/json" \
  -d '{"userId":"test_user","counselorId":"test_counselor"}'

# ÏùëÎãµ ÏòàÏãú
{
  "success": true,
  "sessionId": "sess_...",
  "startedAt": 1761390973946
}
```

---

## üöÄ Phase 6: Render Î∞∞Ìè¨ (5Î∂Ñ)

### Step 17: Render ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï

1. **Render Dashboard** Ï†ëÏÜç
2. BeMore Backend ÏÑúÎπÑÏä§ ÏÑ†ÌÉù
3. **Environment** ÌÉ≠
4. ÏÉà ÌôòÍ≤Ω Î≥ÄÏàò Ï∂îÍ∞Ä:
   ```
   Key: DATABASE_URL
   Value: [Supabase Ïó∞Í≤∞ Î¨∏ÏûêÏó¥]
   ```
5. **Save** ÌÅ¥Î¶≠

### Step 18: Render Î∞∞Ìè¨

**Î∞©Î≤ï A: ÏûêÎèô Î∞∞Ìè¨**
```bash
git add .
git commit -m "chore: update database to Supabase"
git push origin main
```

**Î∞©Î≤ï B: ÏàòÎèô Î∞∞Ìè¨**
1. Render Dashboard
2. **Deploys** ÌÉ≠
3. **Create Deploy** ÌÅ¥Î¶≠

### Step 19: ÌîÑÎ°úÎçïÏÖò Í≤ÄÏ¶ù

2Î∂Ñ ÎåÄÍ∏∞ ÌõÑ:

```bash
# ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏
curl https://bemore-backend.onrender.com/health | python3 -m json.tool

# ÏòàÏÉÅ Í≤∞Í≥º
{
  "status": "ok",
  "message": "Server is running",
  "database": "connected"
}
```

---

## üìã ÏµúÏ¢Ö Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

### Supabase ÏÑ§Ï†ï
- [ ] ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å
- [ ] Step 0-8 Î™®Îì† SQL Ïã§Ìñâ ÏôÑÎ£å
- [ ] 13Í∞ú ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÌôïÏù∏
- [ ] RLS ÌôúÏÑ±Ìôî Î∞è Ï†ïÏ±Ö ÏÑ§Ï†ï ÏôÑÎ£å
- [ ] Ïó∞Í≤∞ Î¨∏ÏûêÏó¥ Î≥µÏÇ¨ ÏôÑÎ£å

### Backend Ïó∞Îèô
- [ ] .env ÌååÏùº DATABASE_URL ÏÑ§Ï†ï
- [ ] [config/database.js](config/database.js) ÌôïÏù∏
- [ ] Î°úÏª¨ `npm run dev` ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ
- [ ] ÏÑ∏ÏÖò ÏÉùÏÑ± API ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ

### Render Î∞∞Ìè¨
- [ ] DATABASE_URL ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
- [ ] ÏΩîÎìú Î∞∞Ìè¨ ÏôÑÎ£å
- [ ] `/health` ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏùëÎãµ ÌôïÏù∏
- [ ] ÌîÑÎ°úÎçïÏÖò ÏÑ∏ÏÖò ÏÉùÏÑ± ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ

---

## üéØ Îã§Ïùå Îã®Í≥Ñ

### Ï¶âÏãú ÏßÑÌñâ
1. ‚úÖ Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î∞è Ïä§ÌÇ§Îßà ÏÑ§Ï†ï
2. ‚úÖ Backend DATABASE_URL Ïó∞Îèô
3. ‚úÖ Render ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï Î∞è Î∞∞Ìè¨

### Ìñ•ÌõÑ ÏûëÏóÖ
- Frontend Supabase ÏÑ§Ï†ï (Î≥ÑÎèÑ Í∞ÄÏù¥Îìú)
- Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î∞±ÏóÖ ÏÑ§Ï†ï
- ÏÑ±Îä• ÏµúÏ†ÅÌôî (Ïù∏Îç±Ïä§, Ï∫êÏã±)
- ÌîÑÎ°úÎçïÏÖò Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò

---

**Status**: ‚úÖ Î™®Îì† Îã®Í≥Ñ Ï§ÄÎπÑ ÏôÑÎ£å
**ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ**: 30Î∂Ñ (Î™®Îì† Phase Ìè¨Ìï®)
**Îã§Ïùå**: Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏãúÏûë!

