<!DOCTYPE html>
<html lang="ko">


<head>

  <meta charset="UTF-8" />
  <title>Emotion Analyzer Demo</title>
  <style>
    video,
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform: scaleX(-1);
    }

    #status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      z-index: 10;
    }
  </style>

</head>


<body>
  <div id="status">ğŸ¥ ì´ˆê¸°í™” ì¤‘...</div>
  <!-- ì¢…ë£Œ ë²„íŠ¼ ì¶”ê°€ -->
  <button id="stopBtn" style="position: fixed; top: 10px; right: 10px; z-index: 11; padding: 8px 12px;">ì¢…ë£Œ</button>
  <video id="input_video" autoplay playsinline></video>
  <canvas id="output_canvas"></canvas>


  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>


  <script>
    const statusDiv = document.getElementById("status");
    const videoElement = document.getElementById("input_video");
    const canvasElement = document.getElementById("output_canvas");
    const canvasCtx = canvasElement.getContext("2d");

    // ====== WebSocket ì—°ê²° ======
    const ws = new WebSocket("ws://localhost:8000");
    ws.onopen = () => (statusDiv.textContent = "âœ… WebSocket ì—°ê²° ì™„ë£Œ");
    ws.onmessage = (msg) => {
      try {
        const data = JSON.parse(msg.data);
        if (data.type === 'analysis_result' || data.emotion) {
          statusDiv.textContent = `ğŸ˜ƒ ê°ì •: ${data.emotion || data.emotion}`;
        } else if (data.type === 'final_analysis') {
          // ìµœì¢… ë¶„ì„ ê²°ê³¼ í‘œì‹œ
          showFinalAnalysis(data);
        } else if (data.type === 'stop_refused') {
          alert('ì¢…ë£Œ ê±°ë¶€: ' + (data.reason || 'ì„¸ì…˜ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
        }
      } catch (e) { console.error('ws message parse error', e); }
    };

    // ====== Mediapipe FaceMesh ì„¤ì • ======
    const faceMesh = new FaceMesh({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });

    let frameCount = 0;
    faceMesh.onResults((results) => {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(
        results.image,
        0,
        0,
        canvasElement.width,
        canvasElement.height
      );

      if (results.multiFaceLandmarks) {
        for (const landmarks of results.multiFaceLandmarks) {
          for (const point of landmarks) {
            const x = point.x * canvasElement.width;
            const y = point.y * canvasElement.height;
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 1.5, 0, 2 * Math.PI);
            canvasCtx.fillStyle = "red";
            canvasCtx.fill();
          }
        }

        frameCount++;
        if (frameCount % 3 === 0 && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(results.multiFaceLandmarks));
        }
      }
    });

    // ====== ì¹´ë©”ë¼ ì‹œì‘ ======
    const camera = new Camera(videoElement, {
      onFrame: async () => await faceMesh.send({ image: videoElement }),
      width: 640,
      height: 480,
    });
    camera.start();

    // ====== ë§ˆì´í¬ ë…¹ìŒ ë° STT ì „ì†¡ (ìˆ˜ì •ëœ ì•ˆì •ì ì¸ ë¡œì§) ======
    let mediaRecorder;
    let audioChunks = [];
    let audioStream;
    let recordingInterval;

    // MediaRecorderë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‹œì‘í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    const initAndStartRecorder = (stream) => {
      // ì´ì „ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì¤‘ì§€í•˜ê³  ì •ë¦¬ (ì•ˆì „ ì¡°ì¹˜)
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }

      audioChunks = []; // ë°ì´í„° ë²„í¼ ì´ˆê¸°í™”

      // ìƒˆë¡œìš´ MediaRecorder ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm; codecs=opus" });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          audioChunks.push(e.data);
        }
      };

      mediaRecorder.start(); // ì¦‰ì‹œ ë…¹ìŒ ì‹œì‘
    };

    async function startMicRecording() {
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // ìµœì´ˆ ë…¹ìŒ ì‹œì‘
      initAndStartRecorder(audioStream);

      // 5ì´ˆ ë‹¨ìœ„ë¡œ ìë™ ì „ì†¡ (ì¤‘ì§€ -> ì „ì†¡ -> ì¬ì‹œì‘)
      recordingInterval = setInterval(async () => {

        // 1. ë…¹ìŒ ì¤‘ì§€: ondataavailable ì´ë²¤íŠ¸ë¥¼ ê°•ì œí•˜ì—¬ ì²­í¬ë¥¼ ìµœì¢… í™•ë³´
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        } else {
          // ì´ë¯¸ ë©ˆì¶°ìˆë‹¤ë©´ (ì˜ˆ: ì¤‘ì§€ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘) ì¬ì‹œì‘ë§Œ í•˜ê³  ë°ì´í„° ì „ì†¡ì€ ìŠ¤í‚µ
          initAndStartRecorder(audioStream);
          return;
        }

        // ondataavailableì´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ëœ í›„, audioChunksê°€ ì±„ì›Œì§€ê¸°ë¥¼ ê¸°ë‹¤ë¦¼
        // ë°ì´í„°ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° (setTimeout ëŒ€ì‹  ë‹¤ìŒ ë£¨í”„ì—ì„œ ì²˜ë¦¬)
        // ì¦‰ì‹œ ì‹¤í–‰ë  ê²½ìš°, audioChunks.length === 0 ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°©ì–´ ë¡œì§ ì¶”ê°€

        // 2. ë°ì´í„° ì²˜ë¦¬ ë° ì „ì†¡
        // ondataavailableì´ ì™„ì „íˆ ì‹¤í–‰ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•´ ì ì‹œ ë”œë ˆì´ë¥¼ ì£¼ê±°ë‚˜,
        // ë‹¤ìŒ ì¸í„°ë²Œ ë£¨í”„ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ ë£¨í”„ë¥¼ ìœ„í•´
        // ë°”ë¡œ initAndStartRecorder(audioStream)ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ , í˜„ì¬ í™•ë³´ëœ ì²­í¬ë§Œ í™•ì¸í•©ë‹ˆë‹¤.

        if (audioChunks.length === 0) {
          // ë°ì´í„°ê°€ í™•ë³´ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ìŒ ë£¨í”„ì—ì„œ ì¬ì‹œë„ (ì¤‘ì§€/ì¬ì‹œì‘ì€ initAndStartRecorderì—ì„œ ì²˜ë¦¬ë¨)
          initAndStartRecorder(audioStream);
          return;
        }

        const blob = new Blob(audioChunks, { type: "audio/webm; codecs=opus" });
        // audioChunks = []; // ë²„í¼ëŠ” initAndStartRecorderì—ì„œ ì´ˆê¸°í™”ë¨

        if (blob.size < 500) {
          initAndStartRecorder(audioStream); // ì‘ì€ íŒŒì¼ ë¬´ì‹œ í›„ ì¬ì‹œì‘
          return;
        }

        const formData = new FormData();
        formData.append("audio", blob, `speech_${Date.now()}.webm`);

        // 3. ë…¹ìŒ ì¬ì‹œì‘ (ì „ì†¡ ì „ì— ì‹œì‘í•˜ì—¬ ë¹ˆ ì‹œê°„ ìµœì†Œí™”)
        initAndStartRecorder(audioStream);

        // 4. STT ì „ì†¡
        try {
          const res = await fetch("/api/transcribe", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          console.log("ğŸ—£ï¸ STT ê²°ê³¼:", data.text);
        } catch (err) {
          console.error("STT ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
        }

      }, 5000);

      statusDiv.textContent = "ğŸ¤ ìŒì„± ë…¹ìŒ ì¤‘ + ì–¼êµ´ ì¶”ì  ì¤‘";
    }

    startMicRecording().catch((err) => {
      statusDiv.textContent = "ğŸš« ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message;
    });

    // ====== ì¢…ë£Œ ë²„íŠ¼ ì²˜ë¦¬ (ì„œë²„ í™•ì¸ í›„ ë¡œì»¬ ì •ì§€)
    const stopBtn = document.getElementById('stopBtn');
    stopBtn.addEventListener('click', () => {
      if (ws.readyState !== WebSocket.OPEN) {
        alert('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      // ì„œë²„ì— stop ìš”ì²­ ì „ì†¡
      ws.send(JSON.stringify({ type: 'control', action: 'stop' }));
      statusDiv.textContent = 'ìš”ì²­ ì¤‘... ì„œë²„ ì‘ë‹µ ëŒ€ê¸°';
    });

    // ìµœì¢… ë¶„ì„ UI í‘œì‹œ í•¨ìˆ˜ (ì¢…í•© ë¶„ì„ í˜ì´ì§€)
    function showFinalAnalysis(data) {
      // ì „ì²´ í™”ë©´ ë¶„ì„ íŒ¨ë„ ìƒì„±
      const panel = document.createElement('div');
      panel.id = 'analysisPanel';
      panel.style.position = 'fixed';
      panel.style.left = '0';
      panel.style.top = '0';
      panel.style.width = '100%';
      panel.style.height = '100%';
      panel.style.background = '#f6f8fa';
      panel.style.zIndex = '1000';
      panel.style.overflow = 'auto';
      panel.style.fontFamily = 'sans-serif';

      // ë‚´ë¶€ ìŠ¤íƒ€ì¼
      const container = document.createElement('div');
      container.style.maxWidth = '1000px';
      container.style.margin = '40px auto';
      container.style.background = 'white';
      container.style.borderRadius = '10px';
      container.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
      container.style.padding = '24px';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';

      const title = document.createElement('h2');
      title.textContent = 'ì¢…í•© ê°ì • ë¶„ì„ ê²°ê³¼';

      const controls = document.createElement('div');
      controls.style.display = 'flex';
      controls.style.gap = '8px';

      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'ê²°ê³¼ ë‹¤ìš´ë¡œë“œ';
      downloadBtn.addEventListener('click', () => downloadReport(data));

      const restartBtn = document.createElement('button');
      restartBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
      restartBtn.addEventListener('click', () => {
        // íŒ¨ë„ ì œê±° í›„ ë¦¬ì†ŒìŠ¤ ì¬ì‹œì‘
        document.body.removeChild(panel);
        try { camera.start(); } catch (e) { /* noop */ }
        // ì¬ë…¹ìŒ ì‹œì‘
        startMicRecording().catch(err => console.warn('ì¬ì‹œì‘ ì¤‘ ë§ˆì´í¬ ì˜¤ë¥˜', err));
        frameCount = 0;
        statusDiv.textContent = 'ğŸ¤ ìŒì„± ë…¹ìŒ ì¤‘ + ì–¼êµ´ ì¶”ì  ì¤‘';
      });

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'ë‹«ê¸°';
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(panel);
      });

      controls.appendChild(downloadBtn);
      controls.appendChild(restartBtn);
      controls.appendChild(closeBtn);

      header.appendChild(title);
      header.appendChild(controls);

      // ìš”ì•½ ì„¹ì…˜
      const summary = document.createElement('div');
      summary.style.display = 'grid';
      summary.style.gridTemplateColumns = '1fr 1fr';
      summary.style.gap = '12px';
      summary.style.marginTop = '16px';

      const emotionCard = document.createElement('div');
      emotionCard.style.padding = '16px';
      emotionCard.style.border = '1px solid #e6e9ee';
      emotionCard.style.borderRadius = '8px';
      const emotionTitle = document.createElement('h3');
      emotionTitle.textContent = 'ê°ì • ìš”ì•½';
      const emotionText = document.createElement('p');
      emotionText.style.fontSize = '20px';
      emotionText.style.fontWeight = '600';
      emotionText.textContent = data.emotion || 'ì•Œ ìˆ˜ ì—†ìŒ';
      // ìƒì„¸ ë¦¬í¬íŠ¸(ê°€ëŠ¥í•˜ë©´) í‘œì‹œ
      if (data.detailed_report && data.detailed_report.report) {
        const dr = data.detailed_report.report;
        const drBox = document.createElement('div');
        drBox.style.marginTop = '8px';
        drBox.innerHTML = `<strong>ì‹ ë¢°ë„:</strong> ${dr.confidence ?? '-'}<br/><strong>ì¶”ì²œ:</strong> ${Array.isArray(dr.recommendation) ? dr.recommendation.join('<br/>') : (dr.recommendation || '-')}`;
        emotionCard.appendChild(drBox);
      }
      emotionCard.appendChild(emotionTitle);
      emotionCard.appendChild(emotionText);

      const statsCard = document.createElement('div');
      statsCard.style.padding = '16px';
      statsCard.style.border = '1px solid #e6e9ee';
      statsCard.style.borderRadius = '8px';
      const statsTitle = document.createElement('h3');
      statsTitle.textContent = 'í†µê³„';
      const statsBody = document.createElement('div');
      statsBody.innerHTML = `<p>í”„ë ˆì„ ìˆ˜: ${data.frames_count || 0}</p><p>ë¶„ì„ ì‹œê°: ${data.timestamp || ''}</p>`;
      statsCard.appendChild(statsTitle);
      statsCard.appendChild(statsBody);

      summary.appendChild(emotionCard);
      summary.appendChild(statsCard);

      // STT ì„¹ì…˜
      const sttSection = document.createElement('div');
      sttSection.style.marginTop = '16px';
      const sttTitle = document.createElement('h3');
      sttTitle.textContent = 'STT (ìŒì„± í…ìŠ¤íŠ¸)';
      const sttPre = document.createElement('pre');
      sttPre.style.background = '#f4f6f8';
      sttPre.style.padding = '12px';
      sttPre.style.borderRadius = '6px';
      sttPre.style.maxHeight = '240px';
      sttPre.style.overflow = 'auto';
      sttPre.textContent = data.stt_snippet || '(ë°œí™” ì—†ìŒ)';
      sttSection.appendChild(sttTitle);
      sttSection.appendChild(sttPre);

      // ìƒì„¸ ë¦¬í¬íŠ¸ ì„¹ì…˜
      if (data.detailed_report && data.detailed_report.report) {
        const rep = data.detailed_report.report;
        const repSection = document.createElement('div');
        repSection.style.marginTop = '16px';
        const repTitle = document.createElement('h3');
        repTitle.textContent = 'ìƒì„¸ ë¦¬í¬íŠ¸';
        const repPre = document.createElement('pre');
        repPre.style.background = '#f9fafb';
        repPre.style.padding = '12px';
        repPre.style.borderRadius = '6px';
        repPre.style.maxHeight = '300px';
        repPre.style.overflow = 'auto';
        repPre.textContent = JSON.stringify(rep, null, 2);
        repSection.appendChild(repTitle);
        repSection.appendChild(repPre);
        container.appendChild(repSection);
      }

      // íƒ€ì„ë¼ì¸ / ê°„ë‹¨í•œ ì‹œê°í™”
      const timelineSection = document.createElement('div');
      timelineSection.style.marginTop = '16px';
      const timelineTitle = document.createElement('h3');
      timelineTitle.textContent = 'ê°„ë‹¨ íƒ€ì„ë¼ì¸';
      const timelineCanvas = document.createElement('canvas');
      timelineCanvas.width = 800;
      timelineCanvas.height = 100;
      timelineCanvas.style.width = '100%';
      timelineCanvas.style.border = '1px solid #e6e9ee';
      timelineCanvas.style.borderRadius = '6px';
      timelineSection.appendChild(timelineTitle);
      timelineSection.appendChild(timelineCanvas);

      // ë‚´ìš© ì¡°í•©
      container.appendChild(header);
      container.appendChild(summary);
      container.appendChild(sttSection);
      container.appendChild(timelineSection);
      panel.appendChild(container);
      document.body.appendChild(panel);

      // ê°„ë‹¨í•œ íƒ€ì„ë¼ì¸ ê·¸ë¦¬ê¸° (í”„ë ˆì„ ìˆ˜ ê¸°ë°˜)
      try {
        const ctx = timelineCanvas.getContext('2d');
        ctx.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
        const frames = data.frames_count || 0;
        const maxFrames = Math.max(frames, 60);
        const barWidth = Math.max(4, (timelineCanvas.width / maxFrames) * Math.min(frames, maxFrames));
        ctx.fillStyle = '#4caf50';
        ctx.fillRect(0, timelineCanvas.height / 4, barWidth, timelineCanvas.height / 2);
        ctx.fillStyle = '#000';
        ctx.fillText(`í”„ë ˆì„: ${frames}`, 10, 14);
      } catch (e) { console.warn('íƒ€ì„ë¼ì¸ ë Œë”ë§ ì‹¤íŒ¨', e); }

      // ì„œë²„ê°€ ìˆ˜ë½í•˜ê³  ìµœì¢… ë¶„ì„ì„ ë³´ëƒˆìœ¼ë¯€ë¡œ ë¡œì»¬ ìì› ì •ë¦¬
      try { camera.stop(); } catch (e) { /* noop */ }
      try {
        clearInterval(recordingInterval);
        if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        if (audioStream) audioStream.getTracks().forEach(t => t.stop());
      } catch (e) { console.warn('ë¡œì»¬ ì •ë¦¬ ì˜¤ë¥˜', e); }

      statusDiv.textContent = 'â¹ï¸ ì¸¡ì • ì¤‘ì§€ë¨';
    }

    // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ìœ í‹¸
    function downloadReport(data) {
      const report = {
        emotion: data.emotion,
        frames_count: data.frames_count,
        timestamp: data.timestamp,
        stt_snippet: data.stt_snippet,
        detailed_report: data.detailed_report || null
      };
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `analysis_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ Interval ì •ë¦¬
    window.onbeforeunload = () => {
      clearInterval(recordingInterval);
      if (mediaRecorder && mediaRecorder.stream) {
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
    };
  </script>
  Â 
</body>

</html>