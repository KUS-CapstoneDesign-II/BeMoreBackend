# üöÄ BeMore Í∞úÏÑ†Îêú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà V2.1 (ChatGPT ÏµúÏ¢Ö ÏàòÏ†ï)

**Í∏∞Î∞ò**: ChatGPT ÏµúÏ¢Ö ÌîºÎìúÎ∞± Ï†ÅÏö©
**ÏÉÅÌÉú**: ‚úÖ Î™®Îì† Ï∞®Îã® Ïù¥Ïäà Ìï¥Í≤∞
**ÎÇ†Ïßú**: 2025-10-26
**Ï†ÅÏö© Îã®Í≥Ñ**: Supabase ÏÑ§Ï†ï Ï†Ñ **Î∞òÎìúÏãú ÏÇ¨Ïö©**

---

## ‚ö†Ô∏è V2 ‚Üí V2.1 Ï£ºÏöî Î≥ÄÍ≤ΩÏÇ¨Ìï≠

ChatGPTÍ∞Ä ÏßÄÏ†ÅÌïú **6Í∞ÄÏßÄ Ï∞®Îã® Ïù¥Ïäà Ìï¥Í≤∞**:

1. ‚úÖ **RLSÏóêÏÑú current_user_id() ‚Üí auth.uid() Î≥ÄÍ≤Ω**
2. ‚úÖ **ÏÇ¨Ïö©Ïûê ÏãùÎ≥ÑÏ≤¥Í≥Ñ ÌÜµÏùº (auth_user_id UUID Ï∂îÍ∞Ä)**
3. ‚úÖ **ÌååÌã∞ÏÖîÎãù Íµ¨Î¨∏ ÏàòÏ†ï (date_trunc ÏÇ¨Ïö©)**
4. ‚úÖ **pgcrypto ÌôïÏû• + updated_at/session_id Ìä∏Î¶¨Í±∞ Ï∂îÍ∞Ä**
5. ‚úÖ **ÏàòÏπò ÌïÑÎìú Î≤îÏúÑ Ï†úÏïΩ Ï∂îÍ∞Ä**
6. ‚úÖ **session_id Î∂àÎ≥ÄÏÑ± Í∞ïÏ†ú (Ìä∏Î¶¨Í±∞)**

---

## üîß ÏàòÏ†ïÎêú Ïä§ÌÇ§Îßà V2.1

### Step 0: ÌôïÏû• ÏÑ§Ïπò (ÌïÑÏàò Î®ºÏ†Ä Ïã§Ìñâ)

```sql
-- ============================================
-- ÌôïÏû• ÏÑ§Ïπò (ÌïÑÏàò)
-- ============================================
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

---

### Step 1: ENUM ÌÉÄÏûÖ Ï†ïÏùò

```sql
-- ============================================
-- ENUM ÌÉÄÏûÖ Ï†ïÏùò (Ïó¥Í±∞Ìòï)
-- ============================================

CREATE TYPE emotion_type AS ENUM (
  'happy',
  'sad',
  'angry',
  'anxious',
  'excited',
  'neutral'
);

CREATE TYPE session_status AS ENUM (
  'active',
  'paused',
  'ended'
);

CREATE TYPE counselor_status AS ENUM (
  'active',
  'inactive'
);

CREATE TYPE language_type AS ENUM (
  'ko',
  'en'
);

CREATE TYPE expertise_level_type AS ENUM (
  'beginner',
  'intermediate',
  'expert'
);
```

---

### Step 2: Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò Ï†ïÏùò

```sql
-- ============================================
-- Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò: updated_at ÏûêÎèô Í∞±Ïã†
-- ============================================
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- Í≥µÌÜµ Ìä∏Î¶¨Í±∞ Ìï®Ïàò: session_id Î∂àÎ≥ÄÏÑ± Í∞ïÏ†ú
-- ============================================
CREATE OR REPLACE FUNCTION forbid_update_session_id()
RETURNS trigger AS $$
BEGIN
  IF NEW.session_id IS DISTINCT FROM OLD.session_id THEN
    RAISE EXCEPTION 'session_id is immutable and cannot be updated';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- Í∞êÏÇ¨ Î°úÍ∑∏ Ìï®Ïàò
-- ============================================
CREATE OR REPLACE FUNCTION audit_row()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.bemore_audit_log(table_name, operation, record_id, user_id, old_values, new_values, created_at)
  VALUES (
    TG_TABLE_NAME,
    TG_OP,
    COALESCE(NEW.id, OLD.id),
    (SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()),
    to_jsonb(OLD),
    to_jsonb(NEW),
    now()
  );
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;
```

---

### Step 3: Í∞úÏÑ†Îêú ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨

#### 3.1 bemore_users (Í∏∞Î≥∏ Ï†ïÎ≥¥)
```sql
CREATE TABLE public.bemore_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  auth_user_id UUID UNIQUE NOT NULL,  -- ‚úÖ FIX: Supabase auth.users(id) Îß§Ìïë
  user_id TEXT UNIQUE NOT NULL,       -- Ïô∏Î∂Ä Ìò∏ÌôòÏÑ±Ïö© (ÏùΩÍ∏∞ Ï†ÑÏö©)
  username TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- ============================================
-- Ïù∏Îç±Ïä§
-- ============================================
CREATE INDEX idx_bemore_users_auth_user_id ON public.bemore_users(auth_user_id);
CREATE INDEX idx_bemore_users_user_id ON public.bemore_users(user_id);
CREATE INDEX idx_bemore_users_email ON public.bemore_users(email);

-- ============================================
-- RLS Policy: ‚úÖ auth.uid() ÏÇ¨Ïö© (ÏàòÏ†ï)
-- ============================================
ALTER TABLE public.bemore_users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own record"
  ON public.bemore_users
  FOR SELECT
  USING (auth.uid() = auth_user_id);

CREATE POLICY "Users can insert their own record"
  ON public.bemore_users
  FOR INSERT
  WITH CHECK (auth.uid() = auth_user_id);

CREATE POLICY "Users can update their own record"
  ON public.bemore_users
  FOR UPDATE
  USING (auth.uid() = auth_user_id)
  WITH CHECK (auth.uid() = auth_user_id);

-- ============================================
-- Trigger: updated_at ÏûêÎèô Í∞±Ïã†
-- ============================================
CREATE TRIGGER t_bemore_users_updated
BEFORE UPDATE ON public.bemore_users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ============================================
-- Trigger: Í∞êÏÇ¨ Î°úÍ∑∏
-- ============================================
CREATE TRIGGER audit_bemore_users
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_users
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

#### 3.2 bemore_user_profiles (PII - ÎØºÍ∞ê Ï†ïÎ≥¥ Î∂ÑÎ¶¨)
```sql
CREATE TABLE public.bemore_user_profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  birth_year INTEGER CHECK (birth_year BETWEEN 1900 AND 2025),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ Ï∂îÍ∞Ä
  gender TEXT,
  phone_encrypted BYTEA,  -- pgcryptoÎ°ú ÏïîÌò∏ÌôîÎêú Ï†ÑÌôîÎ≤àÌò∏
  phone_hash TEXT,        -- Í≤ÄÏÉâÏö© Ìï¥Ïãú (Î≥µÌò∏Ìôî Î∂àÍ∞Ä)
  address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_user_profiles_user_id ON public.bemore_user_profiles(user_id);
CREATE INDEX idx_bemore_user_profiles_phone_hash ON public.bemore_user_profiles(phone_hash);

ALTER TABLE public.bemore_user_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own profile"
  ON public.bemore_user_profiles
  FOR SELECT
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE POLICY "Users can update their own profile"
  ON public.bemore_user_profiles
  FOR UPDATE
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE TRIGGER t_bemore_user_profiles_updated
BEFORE UPDATE ON public.bemore_user_profiles
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_user_profiles
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_user_profiles
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 4: Í∞úÏÑ†Îêú ÏÉÅÎã¥ÏÇ¨ Í¥ÄÎ¶¨

#### 4.1 bemore_counselors
```sql
CREATE TABLE public.bemore_counselors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  counselor_id TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  status counselor_status DEFAULT 'active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_counselors_counselor_id ON public.bemore_counselors(counselor_id);
CREATE INDEX idx_bemore_counselors_status ON public.bemore_counselors(status);

-- ÏÉÅÎã¥ÏÇ¨ Ï†ïÎ≥¥Îäî Í≥µÍ∞ú(RLS ÏóÜÏùå) - ÌïÑÏöîÏãú Ï∂îÍ∞Ä

CREATE TRIGGER t_bemore_counselors_updated
BEFORE UPDATE ON public.bemore_counselors
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_counselors
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_counselors
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

#### 4.2 counselor_specialties (Ï†ÑÎ¨∏ Î∂ÑÏïº)
```sql
CREATE TABLE public.counselor_specialties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  counselor_id UUID NOT NULL REFERENCES public.bemore_counselors(id) ON DELETE CASCADE,
  specialty TEXT NOT NULL,
  expertise_level expertise_level_type DEFAULT 'intermediate',  -- ‚úÖ ENUM ÏÇ¨Ïö©
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_counselor_specialties_counselor_id ON public.counselor_specialties(counselor_id);
CREATE INDEX idx_counselor_specialties_specialty ON public.counselor_specialties(specialty);

CREATE TRIGGER t_counselor_specialties_updated
BEFORE UPDATE ON public.counselor_specialties
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_counselor_specialties
AFTER INSERT OR UPDATE OR DELETE ON public.counselor_specialties
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 5: Í∞úÏÑ†Îêú ÏÑ∏ÏÖò Í¥ÄÎ¶¨ (ÌïµÏã¨)

```sql
CREATE TABLE public.bemore_sessions (
  -- ÏãùÎ≥ÑÏûê
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id TEXT UNIQUE NOT NULL,

  -- ‚úÖ FIX: UUID FKÎ°ú ÌÜµÏùº
  user_id UUID NOT NULL REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  counselor_id UUID REFERENCES public.bemore_counselors(id) ON DELETE SET NULL,

  -- ÏÉÅÌÉú
  status session_status NOT NULL DEFAULT 'active',

  -- ÏãúÍ∞Ñ (Î™®Îëê TIMESTAMPTZ)
  started_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  ended_at TIMESTAMP WITH TIME ZONE,
  duration INTERVAL GENERATED ALWAYS AS (ended_at - started_at) STORED,

  -- Í∞êÏ†ï Îç∞Ïù¥ÌÑ∞
  emotions_data JSONB DEFAULT '[]'::jsonb,

  -- ‚úÖ FIX: Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌïÑÎìúÏóê Î≤îÏúÑ Ï†úÏïΩ Ï∂îÍ∞Ä
  valid_frames INTEGER DEFAULT 0 CHECK (valid_frames >= 0),
  total_frames INTEGER DEFAULT 0 CHECK (total_frames >= 0),
  average_intensity NUMERIC(5, 2) CHECK (average_intensity BETWEEN 0 AND 100),
  speech_seconds NUMERIC(8, 2) CHECK (speech_seconds >= 0),
  silence_seconds NUMERIC(8, 2) CHECK (silence_seconds >= 0),
  words_count INTEGER CHECK (words_count >= 0),

  -- Í∞êÏÇ¨
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- ============================================
-- Ïù∏Îç±Ïä§
-- ============================================
CREATE INDEX idx_bemore_sessions_user_id ON public.bemore_sessions(user_id);
CREATE INDEX idx_bemore_sessions_counselor_id ON public.bemore_sessions(counselor_id);
CREATE INDEX idx_bemore_sessions_status ON public.bemore_sessions(status);
CREATE INDEX idx_bemore_sessions_started_at ON public.bemore_sessions(started_at DESC);
CREATE INDEX idx_bemore_sessions_user_status ON public.bemore_sessions(user_id, status);
CREATE INDEX idx_bemore_sessions_user_date ON public.bemore_sessions(user_id, started_at DESC);

-- ‚úÖ JSONB GIN Ïù∏Îç±Ïä§ (ÌëúÌòÑÏãù Í∏∞Î∞ò)
CREATE INDEX idx_bemore_sessions_emotions_gin ON public.bemore_sessions
USING gin (emotions_data jsonb_path_ops);

-- ============================================
-- RLS Policy: ‚úÖ auth.uid() ÏÇ¨Ïö©
-- ============================================
ALTER TABLE public.bemore_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own sessions"
  ON public.bemore_sessions
  FOR SELECT
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE POLICY "Users can create sessions"
  ON public.bemore_sessions
  FOR INSERT
  WITH CHECK (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE POLICY "Users can update their own sessions"
  ON public.bemore_sessions
  FOR UPDATE
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

-- ============================================
-- Triggers
-- ============================================
CREATE TRIGGER t_bemore_sessions_updated
BEFORE UPDATE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER t_bemore_sessions_sessionid_ro
BEFORE UPDATE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION forbid_update_session_id();

CREATE TRIGGER audit_bemore_sessions
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_sessions
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 6: Í∞êÏ†ï ÌÉÄÏûÑÎùºÏù∏ (Ï†ïÍ∑úÌôî)

```sql
CREATE TABLE public.bemore_emotions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  emotion emotion_type NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
  frame_count INTEGER CHECK (frame_count >= 0),
  stt_snippet TEXT,
  intensity NUMERIC(5, 2) CHECK (intensity BETWEEN 0 AND 100),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ
  confidence_score NUMERIC(5, 4) CHECK (confidence_score BETWEEN 0 AND 1),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ
  face_detected_frames INTEGER CHECK (face_detected_frames >= 0),
  vad_score NUMERIC(5, 4) CHECK (vad_score BETWEEN 0 AND 1),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_emotions_session_id ON public.bemore_emotions(session_id);
CREATE INDEX idx_bemore_emotions_timestamp ON public.bemore_emotions(timestamp DESC);
CREATE INDEX idx_bemore_emotions_emotion ON public.bemore_emotions(emotion);
CREATE INDEX idx_bemore_emotions_session_timestamp ON public.bemore_emotions(session_id, timestamp DESC);

ALTER TABLE public.bemore_emotions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view emotions from their sessions"
  ON public.bemore_emotions
  FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE TRIGGER audit_bemore_emotions
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_emotions
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 7: ÏÑ∏ÏÖò Î©îÌä∏Î¶≠

```sql
CREATE TABLE public.bemore_session_metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,

  total_speech_duration INTERVAL,
  total_silence_duration INTERVAL,
  speech_ratio NUMERIC(5, 2) CHECK (speech_ratio BETWEEN 0 AND 100),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ
  average_words_per_minute NUMERIC(6, 2) CHECK (average_words_per_minute >= 0),

  face_detection_rate NUMERIC(5, 2) CHECK (face_detection_rate BETWEEN 0 AND 100),
  average_face_confidence NUMERIC(5, 4) CHECK (average_face_confidence BETWEEN 0 AND 1),

  emotion_change_count INTEGER CHECK (emotion_change_count >= 0),
  dominant_emotion emotion_type,

  stt_average_confidence NUMERIC(5, 4) CHECK (stt_average_confidence BETWEEN 0 AND 1),
  total_words_recognized INTEGER CHECK (total_words_recognized >= 0),
  recognized_word_ratio NUMERIC(5, 4) CHECK (recognized_word_ratio BETWEEN 0 AND 1),

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_session_metrics_session_id ON public.bemore_session_metrics(session_id);

ALTER TABLE public.bemore_session_metrics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view metrics from their sessions"
  ON public.bemore_session_metrics
  FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE TRIGGER t_bemore_session_metrics_updated
BEFORE UPDATE ON public.bemore_session_metrics
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_session_metrics
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_session_metrics
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 8: ÏÑ∏ÏÖò Î∂ÑÏÑù Î≥¥Í≥†ÏÑú

```sql
CREATE TABLE public.bemore_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,

  emotion_count INTEGER CHECK (emotion_count >= 0),
  primary_emotion emotion_type,
  emotional_state TEXT,
  trend TEXT,

  positive_ratio NUMERIC(5, 2) CHECK (positive_ratio BETWEEN 0 AND 100),
  negative_ratio NUMERIC(5, 2) CHECK (negative_ratio BETWEEN 0 AND 100),
  neutral_ratio NUMERIC(5, 2) CHECK (neutral_ratio BETWEEN 0 AND 100),

  analysis_data JSONB,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_reports_session_id ON public.bemore_reports(session_id);
CREATE INDEX idx_bemore_reports_created_at ON public.bemore_reports(created_at DESC);

ALTER TABLE public.bemore_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view reports from their sessions"
  ON public.bemore_reports
  FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE TRIGGER t_bemore_reports_updated
BEFORE UPDATE ON public.bemore_reports
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_reports
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_reports
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 9: ÏÑ∏ÏÖò Ìö®Í≥º Ï∏°Ï†ï

```sql
CREATE TABLE public.bemore_session_assessments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL UNIQUE REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,

  assessment_instrument TEXT,
  pre_score NUMERIC(5, 2) CHECK (pre_score >= 0),
  post_score NUMERIC(5, 2) CHECK (post_score >= 0),
  score_delta NUMERIC(5, 2) GENERATED ALWAYS AS (post_score - pre_score) STORED,

  effectiveness_rating NUMERIC(3, 1) CHECK (effectiveness_rating BETWEEN 1.0 AND 5.0),
  notes TEXT,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_session_assessments_session_id ON public.bemore_session_assessments(session_id);

ALTER TABLE public.bemore_session_assessments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view assessments from their sessions"
  ON public.bemore_session_assessments
  FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE TRIGGER t_bemore_session_assessments_updated
BEFORE UPDATE ON public.bemore_session_assessments
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_session_assessments
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_session_assessments
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 10: ÌîºÎìúÎ∞±

```sql
CREATE TABLE public.bemore_feedback (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID NOT NULL REFERENCES public.bemore_sessions(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),  -- ‚úÖ Î≤îÏúÑ Ï†úÏïΩ
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_feedback_session_id ON public.bemore_feedback(session_id);
CREATE INDEX idx_bemore_feedback_rating ON public.bemore_feedback(rating);

ALTER TABLE public.bemore_feedback ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can insert feedback for their sessions"
  ON public.bemore_feedback
  FOR INSERT
  WITH CHECK (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Users can view their own feedback"
  ON public.bemore_feedback
  FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM public.bemore_sessions
      WHERE user_id IN (
        SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE TRIGGER audit_bemore_feedback
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_feedback
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 11: ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï

```sql
CREATE TABLE public.bemore_user_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL UNIQUE REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  language language_type DEFAULT 'ko',
  notifications_enabled BOOLEAN DEFAULT true,
  privacy_mode BOOLEAN DEFAULT false,
  theme TEXT DEFAULT 'light' CHECK (theme IN ('light', 'dark', 'auto')),
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_user_preferences_user_id ON public.bemore_user_preferences(user_id);

ALTER TABLE public.bemore_user_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view and update their own preferences"
  ON public.bemore_user_preferences
  FOR ALL
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE TRIGGER t_bemore_user_preferences_updated
BEFORE UPDATE ON public.bemore_user_preferences
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER audit_bemore_user_preferences
AFTER INSERT OR UPDATE OR DELETE ON public.bemore_user_preferences
FOR EACH ROW EXECUTE FUNCTION audit_row();
```

---

### Step 12: ÏõîÎ≥Ñ Í∞êÏ†ï ÏöîÏïΩ

```sql
CREATE TABLE public.bemore_emotion_monthly_summary (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.bemore_users(id) ON DELETE CASCADE,
  year_month DATE NOT NULL,

  emotion emotion_type,
  count INTEGER CHECK (count >= 0),
  average_intensity NUMERIC(5, 2) CHECK (average_intensity BETWEEN 0 AND 100),
  percentage NUMERIC(5, 2) CHECK (percentage BETWEEN 0 AND 100),

  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),

  UNIQUE(user_id, year_month, emotion)
);

CREATE INDEX idx_emotion_monthly_user_id ON public.bemore_emotion_monthly_summary(user_id);
CREATE INDEX idx_emotion_monthly_year_month ON public.bemore_emotion_monthly_summary(year_month);
CREATE INDEX idx_emotion_monthly_user_date ON public.bemore_emotion_monthly_summary(user_id, year_month DESC);

ALTER TABLE public.bemore_emotion_monthly_summary ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own emotion summaries"
  ON public.bemore_emotion_monthly_summary
  FOR SELECT
  USING (
    user_id IN (
      SELECT id FROM public.bemore_users WHERE auth_user_id = auth.uid()
    )
  );

CREATE TRIGGER t_bemore_emotion_monthly_summary_updated
BEFORE UPDATE ON public.bemore_emotion_monthly_summary
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```

---

### Step 13: Í∞êÏÇ¨ Î°úÍ∑∏

```sql
CREATE TABLE public.bemore_audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  table_name TEXT NOT NULL,
  operation TEXT NOT NULL CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
  record_id UUID NOT NULL,
  user_id UUID REFERENCES public.bemore_users(id) ON DELETE SET NULL,
  old_values JSONB,
  new_values JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_bemore_audit_log_table ON public.bemore_audit_log(table_name);
CREATE INDEX idx_bemore_audit_log_user_id ON public.bemore_audit_log(user_id);
CREATE INDEX idx_bemore_audit_log_created_at ON public.bemore_audit_log(created_at DESC);

-- ‚úÖ RLS Ï†úÏô∏ (ÏãúÏä§ÌÖú Î°úÍ∑∏)
```

---

### Step 14: ÌååÌã∞ÏÖîÎãù ÏÑ§Ï†ï (ÏÑ†ÌÉùÏÇ¨Ìï≠ - Îç∞Ïù¥ÌÑ∞ ÎßéÏùÑ Îïå)

```sql
-- ============================================
-- ÌååÌã∞ÏÖîÎãù: bemore_emotions ÏõîÎ≥Ñ Î∂ÑÌï†
-- ============================================
-- ‚ö†Ô∏è Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î®ºÏ†Ä Î∞±ÏóÖ ÌõÑ ÌÖåÏù¥Î∏î Ïû¨ÏÉùÏÑ± ÌïÑÏöî

ALTER TABLE public.bemore_emotions PARTITION BY RANGE (date_trunc('month', timestamp));

-- ÌååÌã∞ÏÖò ÏÉùÏÑ± (ÏïûÏúºÎ°ú 6Í∞úÏõî)
CREATE TABLE public.bemore_emotions_2025_10
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

CREATE TABLE public.bemore_emotions_2025_11
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

CREATE TABLE public.bemore_emotions_2025_12
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');

CREATE TABLE public.bemore_emotions_2026_01
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

CREATE TABLE public.bemore_emotions_2026_02
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

CREATE TABLE public.bemore_emotions_2026_03
  PARTITION OF public.bemore_emotions
  FOR VALUES FROM ('2026-03-01') TO ('2026-04-01');
```

---

## üìä V2.1 ÏµúÏ¢Ö Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

| Ìï≠Î™© | ÏÉÅÌÉú | ÌôïÏù∏ |
|------|------|------|
| RLSÏóêÏÑú current_user_id() ‚Üí auth.uid() Î≥ÄÍ≤Ω | ‚úÖ | Step 3, 4, 5 Îì± Î™®Îì† Ï†ïÏ±Ö |
| auth_user_id Ï∂îÍ∞Ä (Supabase Auth Ïó∞Îèô) | ‚úÖ | Step 3.1 |
| ÏÑ∏ÏÖò user_idÎ•º UUID FKÎ°ú ÌÜµÏùº | ‚úÖ | Step 5 |
| ÌååÌã∞ÏÖîÎãù Íµ¨Î¨∏ ÏàòÏ†ï (date_trunc ÏÇ¨Ïö©) | ‚úÖ | Step 14 |
| pgcrypto ÌôïÏû• ÏÑ§Ïπò | ‚úÖ | Step 0 |
| updated_at Ìä∏Î¶¨Í±∞ Ï∂îÍ∞Ä | ‚úÖ | Step 2 + Î™®Îì† ÌÖåÏù¥Î∏î |
| session_id Î∂àÎ≥ÄÏÑ± Ìä∏Î¶¨Í±∞ | ‚úÖ | Step 2 + Step 5 |
| ÏàòÏπò ÌïÑÎìú Î≤îÏúÑ Ï†úÏïΩ | ‚úÖ | Î™®Îì† NUMERIC/INTEGER |
| Í∞êÏÇ¨ Î°úÍ∑∏ Ìä∏Î¶¨Í±∞ | ‚úÖ | Step 2 + Î™®Îì† ÌÖåÏù¥Î∏î |
| ENUM ÌÉÄÏûÖ (expertise_level Ìè¨Ìï®) | ‚úÖ | Step 1 |

---

## üéØ Ï†ÅÏö© ÏàúÏÑú

```
1Ô∏è‚É£  Step 0: pgcrypto ÌôïÏû• ÏÑ§Ïπò
2Ô∏è‚É£  Step 1: ENUM ÌÉÄÏûÖ Ï†ïÏùò
3Ô∏è‚É£  Step 2: Ìä∏Î¶¨Í±∞ Ìï®Ïàò Ï†ïÏùò
4Ô∏è‚É£  Step 3-13: ÌÖåÏù¥Î∏î ÏÉùÏÑ± (ÏàúÏÑúÎåÄÎ°ú)
5Ô∏è‚É£  Step 14: ÌååÌã∞ÏÖîÎãù (ÏÑ†ÌÉù)
```

---

## ‚ú® ÎπÑÍµê: V2 vs V2.1

| Ìï≠Î™© | V2 | V2.1 | Î≥ÄÍ≤Ω |
|------|----|----|------|
| RLS Ìï®Ïàò | current_user_id() | auth.uid() ‚úÖ | FIX |
| ÏÇ¨Ïö©Ïûê ÏãùÎ≥Ñ | user_id TEXTÎßå | auth_user_id UUID + user_id TEXT | FIX |
| Ìä∏Î¶¨Í±∞ | ÏóÜÏùå | updated_at, forbid_sessionid, audit | FIX |
| Î≤îÏúÑ Ï†úÏïΩ | Î∂ÄÎ∂Ñ | Î™®Îì† ÏàòÏπò ÌïÑÎìú ‚úÖ | FIX |
| ÌååÌã∞ÏÖîÎãù Íµ¨Î¨∏ | ÏûòÎ™ªÎêú ÏòàÏãú | date_trunc + ÌååÌã∞ÏÖò DDL ‚úÖ | FIX |
| Í∞êÏÇ¨ Î°úÍ∑∏ ÏûëÎèô | ÌÖåÏù¥Î∏îÎßå | Ìä∏Î¶¨Í±∞ Ìè¨Ìï® ‚úÖ | FIX |
| ENUM | Í∏∞Î≥∏ 4Í∞ú | +expertise_level ‚úÖ | FIX |

---

## üéä ÏµúÏ¢Ö ÏÉÅÌÉú

**Î™®Îì† ChatGPT Ï∞®Îã® Ïù¥Ïäà Ìï¥Í≤∞ ‚úÖ**
**Ï¶âÏãú Ï†ÅÏö© Í∞ÄÎä• ‚úÖ**
**ÏóîÌÑ∞ÌîÑÎùºÏù¥Ï¶àÍ∏â ÏÑ§Í≥Ñ ‚úÖ**

Îã§Ïùå Îã®Í≥Ñ: Supabase SQL EditorÏóêÏÑú **Step 0Î∂ÄÌÑ∞ Ï∞®Î°ÄÎåÄÎ°ú Ïã§Ìñâ**

---

**ÏûëÏÑ±**: Claude Code
**Í∏∞Î∞ò**: ChatGPT ÏµúÏ¢Ö ÌîºÎìúÎ∞± (6Í∞ÄÏßÄ Ï∞®Îã® Ïù¥Ïäà Î™®Îëê ÏàòÏ†ï)
**ÏÉÅÌÉú**: ‚úÖ ÌîÑÎ°úÎçïÏÖò Ï†ÅÏö© Ï§ÄÎπÑ ÏôÑÎ£å
