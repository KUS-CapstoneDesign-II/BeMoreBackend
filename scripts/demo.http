###############################################################################
# ğŸ¯ BeMore Backend - ë©€í‹°ëª¨ë‹¬ ì„¸ì…˜ ë¼ì´í”„ì‚¬ì´í´ ë°ëª¨ í…ŒìŠ¤íŠ¸
#
# ì´ í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ìŒì„ ì‹œì—°í•©ë‹ˆë‹¤:
# 1. ì„¸ì…˜ ìƒì„± (POST /api/session/start)
# 2. ë©€í‹°ëª¨ë‹¬ ë°ì´í„° ë°°ì¹˜ ì—…ë¡œë“œ (frames, audio, stt)
# 3. 1ë¶„ ì£¼ê¸° ë©€í‹°ëª¨ë‹¬ ê²°í•© ë¶„ì„ (tick)
# 4. ê²°ê³¼ ì¡°íšŒ (GET /api/session/:id/inferences)
# 5. ì„¸ì…˜ ì¢…ë£Œ (POST /api/session/:id/end)
#
# ì‚¬ìš© ë°©ë²•:
# 1. VSCodeì—ì„œ REST Client í™•ì¥ ì„¤ì¹˜ (REST Client by Huachao Mao)
# 2. ì´ íŒŒì¼ì„ ì—´ê³  "Send Request" í´ë¦­
# 3. ë˜ëŠ” ì„¤ì •í•œ ë³€ìˆ˜ë“¤ë¡œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰
#
# @host = http://localhost:8000
###############################################################################

@baseUrl = http://localhost:8000
@contentType = application/json
@userId = user_demo_001
@counselorId = counselor_demo_001

###############################################################################
# 1ï¸âƒ£ ì„¸ì…˜ ìƒì„±
###############################################################################

### 1-1. ì„¸ì…˜ ì‹œì‘ - ìƒˆë¡œìš´ ì„¸ì…˜ ìƒì„±
POST {{baseUrl}}/api/session/start HTTP/1.1
Content-Type: {{contentType}}

{
  "userId": "{{userId}}",
  "counselorId": "{{counselorId}}"
}

> {%
  // sessionIdë¥¼ ë³€ìˆ˜ì— ì €ì¥ (í›„ì† ìš”ì²­ì—ì„œ ì‚¬ìš©)
  client.global.set('sessionId', response.body.data.sessionId);
  client.global.set('sessionStartedAt', response.body.data.startedAt);
  console.log('âœ… Session Created:', response.body.data.sessionId);
%}

###############################################################################
# 2ï¸âƒ£ ë©€í‹°ëª¨ë‹¬ ë°ì´í„° ë°°ì¹˜ ì—…ë¡œë“œ
###############################################################################

### 2-1. í‘œì • í”„ë ˆì„ ì—…ë¡œë“œ (10ê°œ)
POST {{baseUrl}}/api/session/{{sessionId}}/frames HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"ts": 1000, "faceLandmarksCompressed": "landmarks_001", "qualityScore": 0.92},
    {"ts": 2000, "faceLandmarksCompressed": "landmarks_002", "qualityScore": 0.88},
    {"ts": 3000, "faceLandmarksCompressed": "landmarks_003", "qualityScore": 0.95},
    {"ts": 4000, "faceLandmarksCompressed": "landmarks_004", "qualityScore": 0.87},
    {"ts": 5000, "faceLandmarksCompressed": "landmarks_005", "qualityScore": 0.90},
    {"ts": 6000, "faceLandmarksCompressed": "landmarks_006", "qualityScore": 0.91},
    {"ts": 7000, "faceLandmarksCompressed": "landmarks_007", "qualityScore": 0.89},
    {"ts": 8000, "faceLandmarksCompressed": "landmarks_008", "qualityScore": 0.93},
    {"ts": 9000, "faceLandmarksCompressed": "landmarks_009", "qualityScore": 0.85},
    {"ts": 10000, "faceLandmarksCompressed": "landmarks_010", "qualityScore": 0.88}
  ]
}

> {%
  console.log('âœ… Frames uploaded:', response.body.data.frameCount);
%}

### 2-2. ìŒì„± ì²­í¬ ì—…ë¡œë“œ (10ê°œ)
POST {{baseUrl}}/api/session/{{sessionId}}/audio HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"tsStart": 1000, "tsEnd": 2000, "vad": true, "rms": 0.65, "pitch": 120.5},
    {"tsStart": 2000, "tsEnd": 3000, "vad": true, "rms": 0.70, "pitch": 125.0},
    {"tsStart": 3000, "tsEnd": 4000, "vad": false, "rms": 0.15, "pitch": null},
    {"tsStart": 4000, "tsEnd": 5000, "vad": true, "rms": 0.68, "pitch": 118.5},
    {"tsStart": 5000, "tsEnd": 6000, "vad": true, "rms": 0.72, "pitch": 128.0},
    {"tsStart": 6000, "tsEnd": 7000, "vad": false, "rms": 0.10, "pitch": null},
    {"tsStart": 7000, "tsEnd": 8000, "vad": true, "rms": 0.66, "pitch": 122.5},
    {"tsStart": 8000, "tsEnd": 9000, "vad": true, "rms": 0.71, "pitch": 126.0},
    {"tsStart": 9000, "tsEnd": 10000, "vad": true, "rms": 0.69, "pitch": 124.0},
    {"tsStart": 10000, "tsEnd": 11000, "vad": false, "rms": 0.12, "pitch": null}
  ]
}

> {%
  console.log('âœ… Audio chunks uploaded:', response.body.data.audioChunkCount);
%}

### 2-3. STT ìŠ¤ë‹ˆí« ì—…ë¡œë“œ (5ê°œ)
POST {{baseUrl}}/api/session/{{sessionId}}/stt HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"tsStart": 1000, "tsEnd": 2500, "text": "ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?", "lang": "ko"},
    {"tsStart": 4000, "tsEnd": 5500, "text": "ì¢‹ì€ í•˜ë£¨ì˜€ì–´ìš”", "lang": "ko"},
    {"tsStart": 7000, "tsEnd": 8500, "text": "ê°ì‚¬í•©ë‹ˆë‹¤, ì •ë§ ë„ì›€ì´ ë˜ì—ˆì–´ìš”", "lang": "ko"},
    {"tsStart": 9000, "tsEnd": 10000, "text": "ë„¤, ì•Œê² ìŠµë‹ˆë‹¤", "lang": "ko"},
    {"tsStart": 11000, "tsEnd": 12000, "text": "ë˜ ëµê²Œìš”", "lang": "ko"}
  ]
}

> {%
  console.log('âœ… STT snippets uploaded:', response.body.data.sttSnippetCount);
%}

###############################################################################
# 3ï¸âƒ£ 1ë¶„ ì£¼ê¸° ë©€í‹°ëª¨ë‹¬ ê²°í•© ë¶„ì„ (tick)
###############################################################################

### 3-1. ì²« ë²ˆì§¸ ë¶„ ë¶„ì„ (minute 0: 0-60ì´ˆ)
POST {{baseUrl}}/api/session/{{sessionId}}/tick HTTP/1.1
Content-Type: {{contentType}}

{
  "minuteIndex": 0
}

> {%
  const inference0 = response.body.data;
  client.global.set('inference0', inference0);
  console.log('âœ… Minute 0 inference:', {
    facialScore: inference0.facialScore,
    vadScore: inference0.vadScore,
    textSentiment: inference0.textSentiment,
    combinedScore: inference0.combinedScore
  });
%}

### 3-2. ë‹¤ì¤‘ ë¶„ ë¶„ì„ ì‹¤í–‰ (ë” ë§ì€ ë°ì´í„°ë¡œ ì¶”ê°€ tick í˜¸ì¶œ)

# ë‘ ë²ˆì§¸ ë¶„ ë¶„ì„ì„ ìœ„í•´ ì¶”ê°€ ë°ì´í„° ì—…ë¡œë“œ
POST {{baseUrl}}/api/session/{{sessionId}}/frames HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"ts": 61000, "faceLandmarksCompressed": "landmarks_011", "qualityScore": 0.89},
    {"ts": 62000, "faceLandmarksCompressed": "landmarks_012", "qualityScore": 0.91},
    {"ts": 63000, "faceLandmarksCompressed": "landmarks_013", "qualityScore": 0.87},
    {"ts": 64000, "faceLandmarksCompressed": "landmarks_014", "qualityScore": 0.90},
    {"ts": 65000, "faceLandmarksCompressed": "landmarks_015", "qualityScore": 0.92}
  ]
}

### ìŒì„± ì²­í¬ ì¶”ê°€
POST {{baseUrl}}/api/session/{{sessionId}}/audio HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"tsStart": 61000, "tsEnd": 62000, "vad": true, "rms": 0.67, "pitch": 121.0},
    {"tsStart": 62000, "tsEnd": 63000, "vad": true, "rms": 0.73, "pitch": 127.5},
    {"tsStart": 63000, "tsEnd": 64000, "vad": false, "rms": 0.12, "pitch": null},
    {"tsStart": 64000, "tsEnd": 65000, "vad": true, "rms": 0.68, "pitch": 123.0},
    {"tsStart": 65000, "tsEnd": 66000, "vad": true, "rms": 0.70, "pitch": 125.5}
  ]
}

### STT ìŠ¤ë‹ˆí« ì¶”ê°€
POST {{baseUrl}}/api/session/{{sessionId}}/stt HTTP/1.1
Content-Type: {{contentType}}

{
  "items": [
    {"tsStart": 61000, "tsEnd": 62500, "text": "ìƒë‹´ì‚¬ë‹˜ ë•ë¶„ì— ë§ì´ ë„ì›€ëì–´ìš”", "lang": "ko"},
    {"tsStart": 64000, "tsEnd": 65000, "text": "ì •ë§ ê°ì‚¬í•´ìš”", "lang": "ko"}
  ]
}

### ë‘ ë²ˆì§¸ ë¶„ ë¶„ì„
POST {{baseUrl}}/api/session/{{sessionId}}/tick HTTP/1.1
Content-Type: {{contentType}}

{
  "minuteIndex": 1
}

> {%
  const inference1 = response.body.data;
  console.log('âœ… Minute 1 inference:', {
    facialScore: inference1.facialScore,
    vadScore: inference1.vadScore,
    textSentiment: inference1.textSentiment,
    combinedScore: inference1.combinedScore
  });
%}

###############################################################################
# 4ï¸âƒ£ ì¶”ë¡  ê²°ê³¼ ì¡°íšŒ
###############################################################################

### 4-1. ì „ì²´ ì¶”ë¡  ê²°ê³¼ ë° í†µê³„ ì¡°íšŒ
GET {{baseUrl}}/api/session/{{sessionId}}/inferences HTTP/1.1

> {%
  const stats = response.body.data.stats;
  console.log('âœ… Inference Statistics:', {
    totalMinutes: stats.totalMinutes,
    avgCombinedScore: stats.avgCombinedScore,
    avgFacialScore: stats.avgFacialScore,
    avgVadScore: stats.avgVadScore,
    avgTextSentiment: stats.avgTextSentiment
  });
%}

###############################################################################
# 5ï¸âƒ£ ì„¸ì…˜ ì¡°íšŒ
###############################################################################

### 5-1. ì„¸ì…˜ ìƒíƒœ ì¡°íšŒ
GET {{baseUrl}}/api/session/{{sessionId}} HTTP/1.1

> {%
  console.log('âœ… Session status:', response.body.data.status);
%}

###############################################################################
# 6ï¸âƒ£ ì„¸ì…˜ ì¢…ë£Œ ë° ìµœì¢… ë¦¬í¬íŠ¸
###############################################################################

### 6-1. ì„¸ì…˜ ì¢…ë£Œ (30ì´ˆ ëŒ€ê¸° í›„ ê°ì • ë°ì´í„° ì·¨í•©)
# NOTE: ì´ ìš”ì²­ì€ 30ì´ˆ ëŒ€ê¸°í•˜ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤
POST {{baseUrl}}/api/session/{{sessionId}}/end HTTP/1.1

> {%
  const data = response.body.data;
  console.log('âœ… Session ended with report:', {
    sessionId: data.sessionId,
    status: data.status,
    duration: data.duration,
    emotionCount: data.emotionCount,
    inferenceStats: {
      totalMinutes: data.inferenceStats.totalMinutes,
      avgCombinedScore: data.inferenceStats.avgCombinedScore
    }
  });

  client.global.set('finalReport', data);
%}

### 6-2. ìµœì¢… ë¦¬í¬íŠ¸ ì¡°íšŒ
GET {{baseUrl}}/api/session/{{sessionId}}/report HTTP/1.1

###############################################################################
# ğŸ“Š ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
###############################################################################

### ğŸ“ˆ ì‹œë‚˜ë¦¬ì˜¤: ë” ê¸´ ì„¸ì…˜ (5ë¶„)
#
# ì´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤:
# 1. 5ë¶„(300ì´ˆ) ë™ì•ˆ ë°ì´í„° ìˆ˜ì§‘
# 2. 1ë¶„ë§ˆë‹¤ (minute 0-4) tick í˜¸ì¶œ
# 3. ê° ë¶„ë§ˆë‹¤ í‰ê·  ì ìˆ˜ ê³„ì‚°
# 4. ì „ì²´ í†µê³„ ìƒì„±
#
# ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´:
# 1. ìƒˆ ì„¸ì…˜ ì‹œì‘
# 2. ê° ë¶„(60ì´ˆ)ë§ˆë‹¤ frames, audio, stt ë°ì´í„° 300ê°œ ì—…ë¡œë“œ
# 3. tick í˜¸ì¶œ (4ë²ˆ)
# 4. inferences ì¡°íšŒí•˜ì—¬ íƒ€ì„ë¼ì¸ í™•ì¸
# 5. ì„¸ì…˜ ì¢…ë£Œí•˜ì—¬ ìµœì¢… ë¦¬í¬íŠ¸ í™•ì¸

###############################################################################
# â±ï¸ íƒ€ì´ë° ê°€ì´ë“œ
###############################################################################
#
# tick í˜¸ì¶œ íƒ€ì´ë°:
# - minute 0: 0-60ì´ˆ ë°ì´í„°ë¡œ tick(0) í˜¸ì¶œ
# - minute 1: 60-120ì´ˆ ë°ì´í„°ë¡œ tick(1) í˜¸ì¶œ
# - minute 2: 120-180ì´ˆ ë°ì´í„°ë¡œ tick(2) í˜¸ì¶œ
# - ...
#
# ë°ì´í„° ì—…ë¡œë“œ:
# - ts/tsStart: ì„¸ì…˜ ì‹œì‘ í›„ ê²½ê³¼ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
# - ì˜ˆ: 30ì´ˆ = 30000ms
#
# ê²°í•© ì ìˆ˜ ê³„ì‚°:
# - combined = 0.5 * facial + 0.3 * vad + 0.2 * text
# - facial: í”„ë ˆì„ í’ˆì§ˆ ìŠ¤ì½”ì–´ì˜ í‰ê· 
# - vad: VAD í™œì„± ë¹„ìœ¨(70%) + RMS í‰ê· (30%)
# - text: ê°ì • ë¶„ì„ ê²°ê³¼ (ê¸ì •: 0.7, ì¤‘ë¦½: 0.5, ë¶€ì •: 0.3)
